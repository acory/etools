# -*- coding: utf-8 -*-
# Generated by Django 1.9.10 on 2017-04-20 12:16
from __future__ import unicode_literals

from django.conf import settings
from django.db import migrations, models, connection
import django.db.models.deletion


def create_user(staff_member, apps):
    User = apps.get_model('auth', 'User')
    UserProfile = apps.get_model('users', 'UserProfile')
    Country = apps.get_model('users', 'Country')

    user = User.objects.create(
        username=staff_member.email,
        email=staff_member.email,
        first_name=staff_member.first_name,
        last_name=staff_member.last_name,
        is_active=staff_member.active,
    )
    UserProfile.objects.create(user=user)

    user.profile.country = Country.objects.get(schema_name=connection.schema_name)

    user.profile.phone_number = staff_member.phone
    user.profile.job_title = staff_member.title
    user.profile.save()

    staff_member.user = user
    staff_member.save(update_fields=['user'])


def create_users(apps, schema_editor):
    TPMPartnerStaffMember = apps.get_model('tpm', 'TPMPartnerStaffMember')

    for staff_member in TPMPartnerStaffMember.objects.all():
        create_user(staff_member, apps)


class Migration(migrations.Migration):

    dependencies = [
        ('tpm', '0009_auto_20170414_1403'),
    ]

    operations = [
        migrations.AlterField(
            model_name='tpmpartnerstaffmember',
            name='user',
            field=models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='tpm_tpmpartnerstaffmember', to=settings.AUTH_USER_MODEL),
        ),
        migrations.RunPython(
            create_users,
        ),
    ]
