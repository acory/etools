# Generated by Django 2.2.3 on 2019-08-14 13:02

from django.db import connection, migrations, models

from etools.applications.core.tests.cases import SCHEMA_NAME

def set_reference_number(apps, schema_editor):
    # Only run this when NOT in test
    if connection.tenant.schema_name != SCHEMA_NAME:
        TPMVisit = apps.get_model("tpm", "tpmvisit")
        for visit in TPMVisit.objects.all():
            visit.reference_number = '{}/{}/{}/TPM'.format(
                getattr(connection.tenant, "country_short_code", ""),
                visit.created.year,
                visit.pk,
            )
            visit.save()


class Migration(migrations.Migration):

    dependencies = [
        ('tpm', '0008_auto_20191016_1312'),
    ]

    operations = [
        migrations.AddField(
            model_name='tpmvisit',
            name='reference_number',
            field=models.CharField(max_length=100, null=True, verbose_name='Reference Number'),
        ),
        migrations.RunPython(set_reference_number),
    ]
