# Generated by Django 2.2.7 on 2020-09-24 14:53

from django.conf import settings
from django.core.exceptions import FieldDoesNotExist
from django.db import migrations, models
import django.db.models.deletion


def migrate_staff_members_to_fk(apps, schema_editor):
    User = apps.get_model(settings.AUTH_USER_MODEL)
    UserProfile = apps.get_model('users', 'UserProfile')
    PartnerStaffMember = apps.get_model('partners', 'PartnerStaffMember')

    try:
        UserProfile._meta.get_field('_partner_staff_member')
    except FieldDoesNotExist:
        # this field was already removed; nothing to do here
        return

    for staff_member in PartnerStaffMember.objects.all():
        user = User.objects.filter(email__iexact=staff_member.email).first()

        if not user:
            user = User.objects.create(
                first_name=staff_member.first_name,
                last_name=staff_member.last_name,
                email=staff_member.email,
                username=staff_member.email,
                is_active=True,
                is_staff=False,
            )
            UserProfile.objects.create(
                user=user,
                job_title=staff_member.title,
                phone_number=staff_member.phone,
            )

        staff_member.user = user
        staff_member.save()


class Migration(migrations.Migration):

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('users', '0015_auto_20200924_1453'),
        ('partners', '0045_partnerstaffmember_user'),
    ]

    operations = [
        migrations.RunPython(migrate_staff_members_to_fk, migrations.RunPython.noop),
        migrations.AlterField(
            model_name='partnerstaffmember',
            name='user',
            field=models.OneToOneField(on_delete=django.db.models.deletion.PROTECT, related_name='partner_staff_member', to=settings.AUTH_USER_MODEL, verbose_name='User'),
        ),
    ]
